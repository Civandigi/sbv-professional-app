<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBV Finanzhilfegesuch Editor</title>
</head>
<body style="margin: 0; padding: 0; font-family: 'Google Sans', 'Roboto', Arial, sans-serif; background: #f9f9fa; height: 100vh; display: flex; flex-direction: column;">

<div style="display: flex; flex-direction: column; height: 100vh;">
    <!-- Main Editor Container -->
    <div style="flex: 1; padding: 20px; overflow-y: auto; background: #f9f9fa; position: relative;">
        
        <!-- Document -->
        <div id="document" 
             contenteditable="true" 
             style="
                width: 100%; 
                max-width: 816px; 
                margin: 0 auto; 
                background: white; 
                box-shadow: 0 0 0 0.75pt #d1d1d1, 0 0 3pt 0.75pt rgba(0,0,0,0.2); 
                padding: 96px 96px 96px 120px; 
                min-height: 500px; 
                outline: none; 
                font-size: 11pt; 
                line-height: 1.15; 
                color: #202124; 
                font-family: 'Google Sans', 'Roboto', Arial, sans-serif;
             ">
            
            <h1 style="font-size: 26px; font-weight: 400; margin: 0 0 18px 0; color: #202124;">Finanzhilfegesuch Absatzförderungsprojekt</h1>
            <p style="margin: 0 0 11pt 0; font-size: 10pt; color: #666;">(Gestützt auf die landwirtschaftliche Absatzförderungsverordnung vom 9. Juni 2006; LAfV)</p>
            
            <h2 style="font-size: 18px; font-weight: 400; margin: 21px 0 6px 0; color: #202124;">1. Angaben zum Gesamtprojekt</h2>
            
            <p style="margin: 0 0 11pt 0;"><strong>Gesuchsteller:</strong> Schweizer Bauernverband SBV</p>
            <p style="margin: 0 0 11pt 0;"><strong>Projekt ID:</strong> 194.1999.2025</p>
            <p style="margin: 0 0 11pt 0;"><strong>Projektleitung:</strong> Oliver Wehrli</p>
            <p style="margin: 0 0 11pt 0;"><strong>Adresse:</strong> Laurstrasse 10</p>
            <p style="margin: 0 0 11pt 0;"><strong>E-Mail:</strong> oliver.wehrli@sbv-usp.ch</p>
            
            <h3 style="font-size: 14px; font-weight: 500; margin: 16px 0 8px 0; color: #202124;">Finanzierungsangaben</h3>
            <p style="margin: 0 0 11pt 0;"><strong>Gesamtprojekt Kosten Total:</strong> CHF 4'411'920</p>
            <p style="margin: 0 0 11pt 0;"><strong>Max. Finanzhilfe Total:</strong> CHF 2'205'960</p>
            <p style="margin: 0 0 11pt 0;"><strong>Total Eigenmittel:</strong> CHF 2'260'000</p>
            
            <h2 style="font-size: 18px; font-weight: 400; margin: 21px 0 6px 0; color: #202124;">1. Zusammenfassung</h2>
            <p style="margin: 0 0 11pt 0;">Im Jahr 2025 verfolgt der Schweizer Bauernverband mit seinem Finanzhilfegesuch das Ziel, die Akzeptanz und das Verständnis der Schweizer Landwirtschaft in der Öffentlichkeit zu erhöhen. <span style="background: #fff3cd; padding: 2px 4px; border-radius: 3px; cursor: pointer; border: 1px solid #f59e0b;" onclick="selectForDemo(this)">Wichtige Zielgruppen sind Konsumenten, Bildungseinrichtungen und die breite Bevölkerung.</span></p>
            
            <p style="margin: 0 0 11pt 0;">Die geplanten Massnahmen umfassen:</p>
            <ul style="margin: 0 0 11pt 20pt;">
                <li><strong>Leitmedien:</strong> Eine nationale Medienkampagne in Print und Online soll die Wahrnehmung der Bäuerinnen und Bauern erhöhen.</li>
                <li><strong>Digitale Medien:</strong> Entwicklung der Wissensplattform schweizerbauern.ch sowie aktiver Einsatz von Social Media.</li>
                <li><strong>Messen und Ausstellungen:</strong> Durchführung modularer Ausstellungen, um landwirtschaftliche Themen erlebbar zu machen.</li>
                <li><strong>Schulprojekte:</strong> Projekte wie „Schule auf dem Bauernhof" sollen Schülerinnen und Schüler sensibilisieren.</li>
            </ul>
            
            <h3 style="font-size: 14px; font-weight: 500; margin: 16px 0 8px 0; color: #202124;">1.1 Gesamtziele</h3>
            <p style="margin: 0 0 11pt 0;">Die Kommunikationsziele sind auf eine starke Marke «Schweizer Bäuerinnen und Bauern» ausgerichtet und leisten einen Beitrag an die Wirkungsziele. Seit der Einführung der Marke im Jahr 2022 wurden viele Erfahrungen mit den neuen Kommunikationsmitteln gesammelt.</p>
            
            <h2 style="font-size: 18px; font-weight: 400; margin: 21px 0 6px 0; color: #202124;">2. Einleitung</h2>
            <p style="margin: 0 0 11pt 0;">Die Schweizer Landwirtschaft sieht sich derzeit mit mehreren Herausforderungen konfrontiert, darunter der wirtschaftliche Druck auf die Betriebe, der Verlust der Verbindung zur Bevölkerung sowie die steigenden Anforderungen an Nachhaltigkeit und Tierwohl.</p>
            
            <p style="margin: 0 0 11pt 0;"><span style="background: #e3f2fd; padding: 2px 4px; border-radius: 3px; cursor: pointer; border: 1px solid #2196f3;" onclick="selectForDemo(this)">Um diesen Herausforderungen zu begegnen, sollten die vorgeschlagenen Massnahmen der Basiskommunikation intensiviert werden.</span> Diese zielen darauf ab, das Wissen der Bevölkerung über die Landwirtschaft zu erhöhen und ein Bewusstsein für die Vielfalt und die Bedeutung der einheimischen Produkte zu schaffen.</p>
            
            <h3 style="font-size: 14px; font-weight: 500; margin: 16px 0 8px 0; color: #202124;">2.1 Strategische Ausrichtung</h3>
            <p style="margin: 0 0 11pt 0;">Die strategische Ausrichtung des Schweizer Bauernverbands legt einen besonderen Fokus auf die Integration von Nachhaltigkeit, Kommunikation und Zusammenarbeit in der Landwirtschaft. In Anbetracht der zunehmenden Entfremdung der Bevölkerung von der Landwirtschaft ist es von entscheidender Bedeutung, Wissen über die Herkunft und Produktionsweise unserer Lebensmittel zu fördern.</p>
            
        </div>
        
        <!-- Selection Bubble Menu -->
        <div id="bubbleMenu" style="
            position: absolute;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 8px;
            display: none;
            z-index: 1000;
            gap: 4px;
        ">
            <button class="bubble-btn" onclick="triggerKIAction('improve')" style="
                padding: 6px 12px;
                border: none;
                background: transparent;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: #3c4043;
                white-space: nowrap;
                transition: all 0.2s;
            ">KI verbessern</button>
            
            <button class="bubble-btn" onclick="triggerKIAction('summarize')" style="
                padding: 6px 12px;
                border: none;
                background: transparent;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: #3c4043;
                white-space: nowrap;
                transition: all 0.2s;
            ">Zusammenfassen</button>
            
            <button class="bubble-btn" onclick="triggerKIAction('translate')" style="
                padding: 6px 12px;
                border: none;
                background: transparent;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: #3c4043;
                white-space: nowrap;
                transition: all 0.2s;
            ">Übersetzen</button>
            
            <button class="bubble-btn" onclick="triggerKIAction('rewrite')" style="
                padding: 6px 12px;
                border: none;
                background: transparent;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: #3c4043;
                white-space: nowrap;
                transition: all 0.2s;
            ">Umschreiben</button>
        </div>
        
    </div>
    
    <!-- Status Bar -->
    <div style="height: 40px; background: white; border-top: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 20px; font-size: 12px; color: #5f6368;">
        <span id="statusText">Bereit - Wählen Sie Text für KI-Optionen</span>
        <span style="margin-left: auto;">
            Wörter: <span id="wordCount">0</span> | 
            <span id="aiStatus" style="color: #34a853;">KI bereit</span>
        </span>
    </div>
    
</div>

<style>
.bubble-btn:hover {
    background: #f1f3f4 !important;
}

.bubble-btn:active {
    background: #e8f0fe !important;
    color: #1a73e8 !important;
}

/* Highlight animations */
@keyframes highlight-flash {
    0% { background: #fff3cd; }
    50% { background: #ffeb3b; }
    100% { background: #fff3cd; }
}

.processing {
    animation: highlight-flash 1s infinite;
}
</style>

<script>
let selectedText = '';
let selectedRange = null;
let isProcessing = false;

// ERWEITERTE KI Demo responses
const demoResponses = {
    improve: "Im Jahr 2025 verfolgt der Schweizer Bauernverband mit seinem strategischen Finanzhilfegesuch das ambitionierte Ziel, die gesellschaftliche Akzeptanz und das fundierte Verständnis der Schweizer Landwirtschaft in der breiten Öffentlichkeit nachhaltig zu erhöhen und zu festigen.",
    summarize: "SBV Finanzhilfegesuch 2025: Stärkung der öffentlichen Akzeptanz der Schweizer Landwirtschaft durch gezielte Kommunikationsmassnahmen.",
    translate: "In 2025, the Swiss Farmers' Association pursues the goal of increasing acceptance and understanding of Swiss agriculture among the public through its financial aid application.",
    rewrite: "Das Finanzhilfegesuch 2025 des Schweizer Bauernverbands fokussiert sich auf die Erhöhung der gesellschaftlichen Wertschätzung und des Bewusstseins für die Schweizer Landwirtschaft in der Bevölkerung."
};

// Update word count and Retool states
function updateRetoolStates() {
    const editor = document.getElementById('document');
    const text = editor.innerText || '';
    const html = editor.innerHTML || '';
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    
    document.getElementById('wordCount').textContent = wordCount;
    
    // Send to Retool if available
    if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
            type: 'updateState',
            key: 'documentHTML',
            value: html
        }, '*');
        
        window.parent.postMessage({
            type: 'updateState',
            key: 'wordCount',
            value: wordCount
        }, '*');
    }
}

// Handle text selection and show bubble menu
function updateSelection() {
    if (isProcessing) return; // Don't update selection during processing
    
    const selection = window.getSelection();
    const bubbleMenu = document.getElementById('bubbleMenu');
    
    if (selection.rangeCount > 0 && !selection.isCollapsed) {
        selectedText = selection.toString().trim();
        selectedRange = selection.getRangeAt(0).cloneRange();
        
        if (selectedText.length > 5) { // Only show for meaningful selections
            // Position bubble menu
            const rect = selection.getRangeAt(0).getBoundingClientRect();
            const containerRect = document.querySelector('[style*="position: relative"]').getBoundingClientRect();
            
            bubbleMenu.style.display = 'flex';
            bubbleMenu.style.left = Math.max(10, (rect.left - containerRect.left + rect.width/2 - 150)) + 'px';
            bubbleMenu.style.top = Math.max(10, (rect.top - containerRect.top - 60)) + 'px';
            
            document.getElementById('statusText').textContent = `"${selectedText.substring(0, 30)}..." ausgewählt - KI-Optionen verfügbar`;
            
            // Send to Retool
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'updateState',
                    key: 'selectedText',
                    value: selectedText
                }, '*');
            }
        }
    } else {
        bubbleMenu.style.display = 'none';
        selectedText = '';
        selectedRange = null;
        document.getElementById('statusText').textContent = 'Bereit - Wählen Sie Text für KI-Optionen';
    }
}

// Select text for demo (when clicking highlighted spans)
function selectForDemo(element) {
    const range = document.createRange();
    range.selectNode(element);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);
    
    // Small delay to ensure selection is processed
    setTimeout(() => {
        updateSelection();
    }, 100);
}

// Trigger KI Action with visual feedback
function triggerKIAction(action) {
    if (!selectedText || isProcessing) return;
    
    isProcessing = true;
    const bubbleMenu = document.getElementById('bubbleMenu');
    bubbleMenu.style.display = 'none';
    
    // Add processing class to selected text
    if (selectedRange) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(selectedRange);
        
        // Create temporary span for visual feedback
        const span = document.createElement('span');
        span.className = 'processing';
        span.style.background = '#ffeb3b';
        span.style.padding = '2px 4px';
        span.style.borderRadius = '3px';
        
        try {
            selectedRange.surroundContents(span);
        } catch (e) {
            // If surroundContents fails, just continue
            console.log('Could not surround contents');
        }
    }
    
    // Update status
    document.getElementById('statusText').textContent = `KI ${action} wird ausgeführt...`;
    document.getElementById('aiStatus').innerHTML = '<span style="color: #ea4335;">KI arbeitet...</span>';
    
    // Send to Retool
    if (window.parent && window.parent.postMessage) {
        window.parent.postMessage({
            type: 'updateState',
            key: 'kiAction',
            value: action
        }, '*');
        
        window.parent.postMessage({
            type: 'updateState',
            key: 'kiTrigger',
            value: Date.now()
        }, '*');
    }
    
    // Demo: Replace with demo response after 3 seconds
    setTimeout(() => {
        const response = demoResponses[action] || `Verbesserte Version für ${action}: ${selectedText}`;
        replaceWithKIResponse(response);
    }, 3000);
}

// Replace selected text with KI response
function replaceWithKIResponse(response) {
    // Remove processing class
    const processingElements = document.querySelectorAll('.processing');
    processingElements.forEach(el => {
        el.outerHTML = el.innerHTML;
    });
    
    if (selectedRange && response) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(selectedRange);
        
        // Replace text
        selection.deleteFromDocument();
        
        // Create new span with subtle highlight for replaced text
        const span = document.createElement('span');
        span.style.background = '#e8f5e8';
        span.style.padding = '1px 2px';
        span.style.borderRadius = '2px';
        span.style.border = '1px solid #4caf50';
        span.textContent = response;
        
        selection.getRangeAt(0).insertNode(span);
        
        // Remove highlight after 5 seconds
        setTimeout(() => {
            span.outerHTML = span.innerHTML;
        }, 5000);
        
        updateRetoolStates();
        document.getElementById('statusText').textContent = 'Text erfolgreich mit KI bearbeitet';
        document.getElementById('aiStatus').innerHTML = '<span style="color: #34a853;">KI bereit</span>';
        
        selectedText = '';
        selectedRange = null;
        isProcessing = false;
    }
}

// Initialize event listeners
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('document');
    
    // Content changes
    editor.addEventListener('input', function() {
        updateRetoolStates();
    });
    
    // Selection changes
    document.addEventListener('selectionchange', function() {
        updateSelection();
    });
    
    // Click outside to hide bubble menu
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#bubbleMenu') && !window.getSelection().toString()) {
            document.getElementById('bubbleMenu').style.display = 'none';
        }
    });
    
    // Paste handling
    editor.addEventListener('paste', function(e) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text/plain');
        
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(text));
        }
        
        updateRetoolStates();
    });
    
    // Initial setup
    updateRetoolStates();
    
    // Show welcome message
    setTimeout(() => {
        document.getElementById('statusText').textContent = 'SBV Editor bereit - Klicken Sie auf markierte Texte oder wählen Sie eigenen Text aus';
    }, 1000);
});

// Expose functions for external access
window.sbvEditor = {
    replaceWithKIResponse: replaceWithKIResponse,
    getContent: function() {
        return {
            html: document.getElementById('document').innerHTML,
            text: document.getElementById('document').innerText
        };
    },
    setContent: function(html) {
        document.getElementById('document').innerHTML = html;
        updateRetoolStates();
    }
};
</script>

</body>
</html>