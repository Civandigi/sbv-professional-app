<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Einstellungen - SBV Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primary: #3b82f6;
            --color-secondary: #6b7280;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-success: #10b981;
            --color-text-primary: #111827;
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f9fafb;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-[var(--color-bg-secondary)]">
    <div class="w-full">
        <!-- Header -->
        <div class="p-8 pb-0">
            <div class="flex justify-between items-center">
                <div>
                    <h1 style="font-size: 1.875rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem;">
                        Einstellungen
                    </h1>
                    <p class="text-gray-600">Systemverwaltung und Benutzerkontrolle</p>
                </div>
                <div class="bg-gray-100 px-4 py-2 rounded-lg">
                    <span class="text-gray-700 font-medium" id="userRoleDisplay">Rolle wird geladen...</span>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="px-8 mt-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8 overflow-x-auto">
                <button class="tab-button active py-3 px-4 border-b-2 border-blue-500 text-gray-900 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('dashboard')">
                    Dashboard
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('users')">
                    Benutzerverwaltung
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('security')">
                    Sicherheit
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('api')">
                    API-Verwaltung
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('sessions')">
                    Sessions
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('system')">
                    System
                </button>
                <button class="tab-button py-3 px-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm whitespace-nowrap"
                        onclick="showTab('profile')">
                    Profil
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-8">
            
            <!-- Admin Dashboard -->
            <div id="dashboardTab" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex items-center">
                            <div class="p-3 bg-blue-100 rounded-lg mr-4">
                                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="totalUsers">8</p>
                                <p class="text-gray-600">Benutzer gesamt</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex items-center">
                            <div class="p-3 bg-green-100 rounded-lg mr-4">
                                <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 6.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM21 10.5h-6.5L12 7 9.5 10.5H3v2h6.5L12 16l2.5-3.5H21v-2z"/>
                                    <path d="M7.5 19a1.5 1.5 0 100-3 1.5 1.5 0 000 3zM16.5 19a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="activeAdmins">3</p>
                                <p class="text-gray-600">Aktive Admins</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                        <div class="flex items-center">
                            <div class="p-3 bg-orange-100 rounded-lg mr-4">
                                <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                                </svg>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-gray-900" id="activeSessions">12</p>
                                <p class="text-gray-600">Aktive Sessions</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-sm p-6 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">K√ºrzliche Aktivit√§ten</h3>
                    <div id="recentActivities" class="space-y-3">
                        <div class="flex items-center py-3 border-b border-gray-100">
                            <div class="p-2 bg-green-100 rounded-lg mr-3">
                                <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Neuer Benutzer erstellt</p>
                                <p class="text-sm text-gray-600">admin@sbv.ch hat einen neuen Benutzer angelegt</p>
                                <p class="text-xs text-gray-500">vor 5 Minuten</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center py-3 border-b border-gray-100">
                            <div class="p-2 bg-blue-100 rounded-lg mr-3">
                                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2A2,2 0 0,1 14,4A2,2 0 0,1 12,6A2,2 0 0,1 10,4A2,2 0 0,1 12,2M21,9V7L15,4V6A2,2 0 0,1 13,8A2,2 0 0,1 11,6V4L5,7V9A2,2 0 0,1 7,11A2,2 0 0,1 9,9H11A2,2 0 0,1 13,11A2,2 0 0,1 15,9V11A2,2 0 0,1 17,13A2,2 0 0,1 19,11V9M12,13C10,13 8,14 6,15V17A2,2 0 0,0 8,19H16A2,2 0 0,0 18,17V15C16,14 14,13 12,13Z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Admin-Login erfolgreich</p>
                                <p class="text-sm text-gray-600">superadmin@digitale-rakete.ch angemeldet</p>
                                <p class="text-xs text-gray-500">vor 12 Minuten</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center py-3 border-b border-gray-100">
                            <div class="p-2 bg-yellow-100 rounded-lg mr-3">
                                <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Session-Timeout ge√§ndert</p>
                                <p class="text-sm text-gray-600">Timeout auf 30 Minuten aktualisiert</p>
                                <p class="text-xs text-gray-500">vor 18 Minuten</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center py-3 border-b border-gray-100">
                            <div class="p-2 bg-purple-100 rounded-lg mr-3">
                                <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20,18C20,21.63 16.79,22.87 12,22.87C7.21,22.87 4,21.63 4,18V6C4,2.37 7.21,1.13 12,1.13C16.79,1.13 20,2.37 20,6V18Z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Datenbank-Backup erstellt</p>
                                <p class="text-sm text-gray-600">Automatisches Backup erfolgreich abgeschlossen</p>
                                <p class="text-xs text-gray-500">vor 1 Stunde</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center py-3 border-b border-gray-100">
                            <div class="p-2 bg-red-100 rounded-lg mr-3">
                                <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M13,14H11V10H13M13,18H11V16H13M1,21H23L12,2L1,21Z"/>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">Login-Versuch fehlgeschlagen</p>
                                <p class="text-sm text-gray-600">Ung√ºltiger Versuch von IP 192.168.1.105</p>
                                <p class="text-xs text-gray-500">vor 2 Stunden</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Alle Aktivit√§ten anzeigen ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <!-- Benutzerverwaltung Tab -->
            <div id="usersTab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Benutzerverwaltung</h2>
                            <p class="text-gray-600">Verwalten Sie alle Systembenutzer und ihre Berechtigungen</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportUsers()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Exportieren
                            </button>
                            <button onclick="openUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                Benutzer hinzuf√ºgen
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filter und Suche -->
                    <div class="mb-6 flex gap-4">
                        <input type="text" id="userSearch" placeholder="Benutzer suchen..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <select id="roleFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Alle Rollen</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="user">Benutzer</option>
                        </select>
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Alle Status</option>
                            <option value="aktiv">Aktiv</option>
                            <option value="inaktiv">Inaktiv</option>
                        </select>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded border-gray-300">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">E-Mail</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rolle</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Letzter Login</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                        <div class="flex items-center justify-center">
                                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            Benutzer werden geladen...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bulk Actions -->
                    <div id="bulkActions" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                        <div class="flex items-center gap-4">
                            <span class="font-medium"><span id="selectedCount">0</span> Benutzer ausgew√§hlt</span>
                            <button onclick="bulkActivate()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                Aktivieren
                            </button>
                            <button onclick="bulkDeactivate()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700">
                                Deaktivieren
                            </button>
                            <button onclick="bulkDelete()" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                L√∂schen
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sicherheit Tab -->
            <div id="securityTab" class="tab-content">
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">Sicherheitseinstellungen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold mb-3">Passwort-Richtlinien</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-3" checked>
                                        <span>Mindestens 8 Zeichen</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-3" checked>
                                        <span>Gro√übuchstaben erforderlich</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" class="mr-3">
                                        <span>Sonderzeichen erforderlich</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-3">Session-Einstellungen</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Session-Timeout (Minuten)</label>
                                        <input type="number" value="60" class="w-full px-3 py-2 border rounded-lg">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Max. gleichzeitige Sessions</label>
                                        <input type="number" value="5" class="w-full px-3 py-2 border rounded-lg">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">Zwei-Faktor-Authentifizierung</h3>
                        <p class="text-gray-600 mb-4">Aktivieren Sie 2FA f√ºr alle Admin-Konten</p>
                        <button class="bg-[var(--color-secondary)] text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            2FA f√ºr alle Admins aktivieren
                        </button>
                    </div>
                </div>
            </div>

            <!-- API Tab -->
            <div id="apiTab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-semibold">API-Schl√ºssel Verwaltung</h2>
                            <p class="text-gray-600">Verwalten Sie API-Schl√ºssel f√ºr externe Integrationen</p>
                        </div>
                        <button onclick="generateApiKey()" class="bg-[var(--color-secondary)] text-white px-4 py-2 rounded-lg hover:bg-green-700">
                            <i class="fas fa-plus mr-2"></i>Neuen Schl√ºssel erstellen
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Schl√ºssel</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Erstellt</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="apiKeyTable">
                                <tr>
                                    <td class="px-6 py-4">SBV Mobile App</td>
                                    <td class="px-6 py-4">
                                        <code class="bg-gray-100 px-2 py-1 rounded">sbv_***********4a2f</code>
                                        <button onclick="copyApiKey('sbv_1234567890abcdef4a2f')" class="ml-2 text-blue-600 hover:text-blue-800">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </td>
                                    <td class="px-6 py-4">22.07.2025</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                            Aktiv
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <button class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessionsTab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl font-semibold">Aktive Sessions</h2>
                            <p class="text-gray-600">√úbersicht aller aktiven Benutzer-Sessions</p>
                        </div>
                        <button onclick="refreshSessions()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-sync-alt mr-2"></i>Aktualisieren
                        </button>
                    </div>
                    
                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-2xl font-bold text-blue-600" id="totalSessions">-</p>
                            <p class="text-blue-600">Sessions gesamt</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-2xl font-bold text-green-600" id="adminSessions">-</p>
                            <p class="text-green-600">Admin Sessions</p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg">
                            <p class="text-2xl font-bold text-orange-600" id="userSessions">-</p>
                            <p class="text-orange-600">Benutzer Sessions</p>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Benutzer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP-Adresse</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gestartet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Letzte Aktivit√§t</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="sessionTable">
                                <!-- Sessions werden hier geladen -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="systemTab" class="tab-content">
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-4">System-Informationen</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold mb-3">Server Status</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Status:</span>
                                        <span class="text-green-600 font-semibold">Online</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Uptime:</span>
                                        <span id="serverUptime">-</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Version:</span>
                                        <span>SBV-Pro v2.1.0</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold mb-3">Datenbank</h3>
                                <div class="space-y-2">
                                    <div class="flex justify-between">
                                        <span>Status:</span>
                                        <span class="text-green-600 font-semibold">Verbunden</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Typ:</span>
                                        <span>PostgreSQL</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Gr√∂√üe:</span>
                                        <span id="dbSize">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">System-Aktionen</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="backupDatabase()" class="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700 text-left">
                                <i class="fas fa-database text-xl mb-2"></i>
                                <p class="font-semibold">Datenbank Backup</p>
                                <p class="text-sm opacity-90">Erstelle ein vollst√§ndiges Backup</p>
                            </button>
                            <button onclick="clearLogs()" class="bg-orange-600 text-white p-4 rounded-lg hover:bg-orange-700 text-left">
                                <i class="fas fa-broom text-xl mb-2"></i>
                                <p class="font-semibold">Logs leeren</p>
                                <p class="text-sm opacity-90">Alte Log-Dateien entfernen</p>
                            </button>
                            <button onclick="restartServer()" class="bg-red-600 text-white p-4 rounded-lg hover:bg-red-700 text-left">
                                <i class="fas fa-power-off text-xl mb-2"></i>
                                <p class="font-semibold">Server Neustart</p>
                                <p class="text-sm opacity-90">Server sicher neustarten</p>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profil Tab -->
            <div id="profileTab" class="tab-content">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Mein Admin-Profil</h2>
                    <form class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                <input type="text" id="adminName" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">E-Mail</label>
                                <input type="email" id="adminEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg" readonly>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rolle</label>
                            <input type="text" id="adminRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                        </div>
                        <div class="pt-4">
                            <button type="button" onclick="updateProfile()" class="bg-[var(--color-secondary)] text-white px-6 py-2 rounded-lg hover:bg-green-700">
                                Profil aktualisieren
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">Neuen Benutzer erstellen</h3>
            <form id="userForm" onsubmit="handleUserSubmit(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Name *</label>
                        <input type="text" name="name" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">E-Mail *</label>
                        <input type="email" name="email" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Rolle</label>
                        <select name="rolle" class="w-full px-3 py-2 border rounded-lg">
                            <option value="user">Benutzer</option>
                            <option value="admin">Administrator</option>
                            <option value="super_admin">Super Administrator</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeUserModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                        Abbrechen
                    </button>
                    <button type="submit" class="px-4 py-2 bg-[var(--color-secondary)] text-white rounded-lg hover:bg-green-700">
                        Erstellen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Globale Variablen
        let currentUsers = [];
        let selectedUsers = [];
        
        // Lade Benutzerinformationen
        const storedUser = sessionStorage.getItem('sbv_benutzer');
        let userRole = 'mitarbeiter';
        let userInfo = null;
        
        if (storedUser) {
            try {
                userInfo = JSON.parse(storedUser);
                userRole = userInfo.rolle || userInfo.role || 'mitarbeiter';
                console.log('Geladene Benutzerrolle:', userRole);
                
                // Aktualisiere Anzeige
                document.getElementById('userRoleDisplay').textContent = userRole.toUpperCase();
                
                if (userInfo.name) {
                    document.getElementById('adminName').value = userInfo.name;
                }
                if (userInfo.email) {
                    document.getElementById('adminEmail').value = userInfo.email;
                }
                document.getElementById('adminRole').value = userRole;
                
            } catch (e) {
                console.error('Fehler beim Parsen der Benutzerinformationen:', e);
            }
        }
        
        const token = sessionStorage.getItem('sbv_token');

        // Tab-Funktionalit√§t
        function showTab(tabName) {
            // Verstecke alle Tab-Inhalte
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Entferne aktive Klasse von allen Buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-[var(--color-secondary)]', 'text-gray-900');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Zeige gew√§hlten Tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active', 'border-[var(--color-secondary)]', 'text-gray-900');
            event.target.classList.remove('border-transparent', 'text-gray-500');
            
            // Lade spezielle Tab-Inhalte
            if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'sessions') {
                loadSessions();
            }
        }

        // Dashboard laden
        // Dashboard wird jetzt von loadDashboardStats() geladen
        // async function loadDashboard() - ENTFERNT, da durch loadDashboardStats() ersetzt

        // Benutzer laden
        async function loadUsers() {
            console.log('üîß DEBUG: Token pr√ºfen...');
            console.log('üîß DEBUG: Token existiert:', !!token);
            console.log('üîß DEBUG: Token L√§nge:', token ? token.length : 0);
            
            // Session Storage nochmal pr√ºfen
            const storedToken = sessionStorage.getItem('sbv_token');
            const storedUser = sessionStorage.getItem('sbv_benutzer');
            
            console.log('üîß DEBUG: Gespeicherter Token existiert:', !!storedToken);
            console.log('üîß DEBUG: Gespeicherter User existiert:', !!storedUser);
            
            if (storedUser) {
                try {
                    const userInfo = JSON.parse(storedUser);
                    console.log('üîß DEBUG: Benutzerrolle:', userInfo.rolle);
                    console.log('üîß DEBUG: Benutzer-ID:', userInfo.id);
                    console.log('üîß DEBUG: Benutzer-Email:', userInfo.email);
                } catch (e) {
                    console.error('üîß DEBUG: Fehler beim User-Parsing:', e);
                }
            }
            
            // Token dekodieren (ohne Verifikation)
            if (storedToken) {
                try {
                    const tokenParts = storedToken.split('.');
                    const payload = JSON.parse(atob(tokenParts[1]));
                    console.log('üîß DEBUG: Token Payload:', payload);
                    console.log('üîß DEBUG: Token Rolle:', payload.rolle);
                    console.log('üîß DEBUG: Token Ablauf:', new Date(payload.exp * 1000).toLocaleString());
                } catch (e) {
                    console.error('üîß DEBUG: Token-Dekodierung fehlgeschlagen:', e);
                }
            }
            
            const currentToken = token || storedToken;
            
            if (!currentToken) {
                document.getElementById('userTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-red-600">
                            Bitte melden Sie sich zuerst an.
                        </td>
                    </tr>
                `;
                return;
            }

            try {
                console.log('üîÑ Lade Benutzer...');
                const response = await fetch('/api/sbv_benutzer', {
                    headers: { 
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üîß DEBUG: Response Status:', response.status);
                console.log('üîß DEBUG: Response OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('üîß DEBUG: Response Error Text:', errorText);
                    
                    if (response.status === 403) {
                        throw new Error('Zugriff verweigert - √úberpr√ºfen Sie Ihre Berechtigung');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                const apiResponse = await response.json();
                console.log('‚úÖ API Response:', apiResponse);
                
                if (apiResponse.success && apiResponse.data) {
                    currentUsers = apiResponse.data;
                    console.log('üë• Geladene Benutzer:', currentUsers.length);
                    renderUserTable(currentUsers);
                } else {
                    throw new Error('API Response Format ung√ºltig: ' + JSON.stringify(apiResponse));
                }
                
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Benutzer:', error);
                document.getElementById('userTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-red-600">
                            Fehler beim Laden der Benutzer: ${error.message}
                            <br><small>√úberpr√ºfen Sie die Browser-Konsole f√ºr Details.</small>
                        </td>
                    </tr>
                `;
            }
        }

        // Benutzer-Tabelle rendern
        function renderUserTable(users) {
            const tbody = document.getElementById('userTableBody');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                            Keine Benutzer gefunden.
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log('üé® Rendere Benutzertabelle mit', users.length, 'Benutzern');
            
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <input type="checkbox" value="${user.id}" onchange="toggleUserSelection(${user.id})">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                                <i class="fas fa-user text-gray-600"></i>
                            </div>
                            ${user.name || 'Unbekannt'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.email || 'Keine E-Mail'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeClass(user.rolle)}">
                            ${user.rolle || 'user'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'aktiv' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${user.status || 'aktiv'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${user.letzter_login ? new Date(user.letzter_login).toLocaleDateString('de-DE') : 'Nie'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                        <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900" title="Bearbeiten">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="resetPassword(${user.id})" class="text-orange-600 hover:text-orange-900" title="Passwort zur√ºcksetzen">
                            <i class="fas fa-key"></i>
                        </button>
                        <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900" title="L√∂schen">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Hilfsfunktion f√ºr Rollen-Badge-Klassen
        function getRoleBadgeClass(rolle) {
            switch(rolle) {
                case 'super_admin': return 'bg-purple-100 text-purple-800';
                case 'admin': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // User Modal Funktionen
        function openUserModal() {
            document.getElementById('userModal').classList.remove('hidden');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.add('hidden');
            document.getElementById('userForm').reset();
        }

        // Benutzer erstellen
        async function handleUserSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/sbv_benutzer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(userData)
                });
                
                if (!response.ok) {
                    throw new Error('Fehler beim Erstellen des Benutzers');
                }
                
                const result = await response.json();
                alert('Benutzer erfolgreich erstellt!');
                
                closeUserModal();
                loadUsers(); // Tabelle aktualisieren
                
            } catch (error) {
                alert('Fehler beim Erstellen des Benutzers: ' + error.message);
            }
        }

        // Weitere Funktionen
        function editUser(userId) {
            console.log('Bearbeite Benutzer:', userId);
            // Implementation hier
        }

        function deleteUser(userId) {
            if (confirm('M√∂chten Sie diesen Benutzer wirklich l√∂schen?')) {
                console.log('L√∂sche Benutzer:', userId);
                // Implementation hier
            }
        }

        function resetPassword(userId) {
            if (confirm('Passwort f√ºr diesen Benutzer zur√ºcksetzen?')) {
                console.log('Setze Passwort zur√ºck f√ºr Benutzer:', userId);
                // Implementation hier
            }
        }

        // Bulk-Aktionen
        function toggleUserSelection(userId) {
            const checkbox = event.target;
            if (checkbox.checked) {
                selectedUsers.push(userId);
            } else {
                selectedUsers = selectedUsers.filter(id => id !== userId);
            }
            updateBulkActions();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('#userTableBody input[type="checkbox"]');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                const userId = parseInt(cb.value);
                if (selectAll.checked && !selectedUsers.includes(userId)) {
                    selectedUsers.push(userId);
                }
            });
            
            if (!selectAll.checked) {
                selectedUsers = [];
            }
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');
            
            selectedCount.textContent = selectedUsers.length;
            
            if (selectedUsers.length > 0) {
                bulkActions.classList.remove('hidden');
            } else {
                bulkActions.classList.add('hidden');
            }
        }

        // System-Funktionen
        function generateApiKey() {
            const keyName = prompt('Name f√ºr den API-Schl√ºssel:');
            if (keyName) {
                console.log('Generiere API-Schl√ºssel f√ºr:', keyName);
                // Implementation hier
            }
        }

        function copyApiKey(key) {
            navigator.clipboard.writeText(key);
            alert('API-Schl√ºssel kopiert!');
        }

        function backupDatabase() {
            if (confirm('Datenbank-Backup erstellen? Dies kann einige Minuten dauern.')) {
                console.log('Erstelle Datenbank-Backup...');
                // Implementation hier
            }
        }

        function clearLogs() {
            if (confirm('Alle Log-Dateien l√∂schen?')) {
                console.log('L√∂sche Log-Dateien...');
                // Implementation hier
            }
        }

        function restartServer() {
            if (confirm('Server wirklich neustarten? Alle Benutzer werden abgemeldet.')) {
                console.log('Starte Server neu...');
                // Implementation hier
            }
        }

        function updateProfile() {
            const name = document.getElementById('adminName').value;
            console.log('Aktualisiere Profil f√ºr:', name);
            // Implementation hier
        }

        function refreshSessions() {
            console.log('Aktualisiere Sessions...');
            loadSessions();
        }

        function loadSessions() {
            // Mock-Daten f√ºr Sessions
            document.getElementById('totalSessions').textContent = '12';
            document.getElementById('adminSessions').textContent = '3';
            document.getElementById('userSessions').textContent = '9';
        }

        // Lade echte Dashboard-Statistiken aus der Datenbank
        async function loadDashboardStats() {
            try {
                const token = sessionStorage.getItem('sbv_token');
                if (!token) {
                    console.error('Kein Token gefunden');
                    return;
                }

                const response = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    console.log('üìä Dashboard-Statistiken geladen:', stats);
                    
                    // Update Dashboard-Karten mit echten Daten
                    document.getElementById('totalUsers').textContent = stats.totalUsers || '8';
                    document.getElementById('activeAdmins').textContent = stats.activeAdmins || '3';
                    document.getElementById('activeSessions').textContent = stats.activeSessions || '12';
                } else {
                    console.warn('Konnte Dashboard-Statistiken nicht laden, verwende Standardwerte');
                    // Fallback-Werte wenn API nicht verf√ºgbar
                    document.getElementById('totalUsers').textContent = '8';
                    document.getElementById('activeAdmins').textContent = '3';
                    document.getElementById('activeSessions').textContent = '12';
                }
            } catch (error) {
                console.error('Fehler beim Laden der Dashboard-Statistiken:', error);
                // Fallback-Werte bei Fehler
                document.getElementById('totalUsers').textContent = '8';
                document.getElementById('activeAdmins').textContent = '3';
                document.getElementById('activeSessions').textContent = '12';
            }
        }

        function exportUsers() {
            console.log('Exportiere Benutzerdaten...');
            // Implementation hier
        }

        // Pr√ºfe Berechtigungen beim Laden
        console.log('Admin-Panel geladen f√ºr Rolle:', userRole);
        
        if (userRole !== 'admin' && userRole !== 'super_admin') {
            alert('Keine Berechtigung f√ºr diese Seite!');
            window.location.href = '/';
        }

        // Lade echte Dashboard-Statistiken beim Start
        loadDashboardStats();
    </script>
</body>
</html>
