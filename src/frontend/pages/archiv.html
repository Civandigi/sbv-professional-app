<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SBV Archiv - Jahres√ºbersicht</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        :root {
            --color-black: #000000;
            --color-light-blue: #A4D2F4;
            --color-green: #6BAF38;
            --color-background: #F8FAFC;
            --color-text-primary: #111827;
            --color-text-secondary: #6B7280;
            --color-card-background: #FFFFFF;
            --color-border: #E5E7EB;
            --color-red: #DC2626;
            --color-orange: #F59E0B;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--color-background);
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-4" style="color: var(--color-text-primary);">Gesuchsjahr ausw√§hlen</h1>
            <p class="text-lg" style="color: var(--color-text-secondary);">W√§hlen Sie das Jahr aus, f√ºr das Sie Gesuche und Berichte verwalten m√∂chten oder erstellen Sie ein neues Archiv.</p>
        </div>

        <!-- Working Year Selection -->
        <div class="mb-12">
            <div class="flex items-end gap-4">
                <div class="flex-1 max-w-xs">
                    <label class="block text-sm font-semibold mb-3" style="color: var(--color-text-primary);">Gesuchsjahr</label>
                    <select class="w-full rounded-lg border py-3 px-4 bg-white" style="border-color: var(--color-border); color: var(--color-text-primary);" id="working-year">
                        <option value="2030">2030</option>
                        <option value="2029">2029</option>
                        <option value="2028">2028</option>
                        <option value="2027">2027</option>
                        <option value="2026">2026</option>
                        <option value="2025" selected>2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button class="flex items-center justify-center gap-2 rounded-lg px-6 py-3 text-white text-sm font-bold hover:opacity-90 transition-colors" style="background-color: var(--color-green);" onclick="uploadGesuch()">
                        <svg fill="currentColor" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <span>Gesuch hochladen</span>
                    </button>
                    <button class="flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-white text-sm font-bold hover:opacity-90 transition-colors" style="background-color: var(--color-orange);" onclick="fixYearMismatches()">
                        üîß Jahre korrigieren
                    </button>
                </div>
            </div>
        </div>

        <!-- Annual Archives Section -->
        <div>
            <h2 class="text-2xl font-bold mb-8" style="color: var(--color-text-primary);">Jahresarchive</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-8">
                
                <!-- 2023 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2023')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2023</p>
                </div>

                <!-- 2022 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2022')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2022</p>
                </div>

                <!-- 2021 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2021')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2021</p>
                </div>

                <!-- 2020 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2020')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2020</p>
                </div>

                <!-- 2019 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2019')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2019</p>
                </div>

                <!-- 2018 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2018')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2018</p>
                </div>

            </div>
        </div>
        
        <!-- Upload Modal -->
        <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold mb-4" style="color: var(--color-text-primary);">Gesuch hochladen</h3>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--color-text-primary);">Gesuch-Datei (PDF)</label>
                        <input type="file" id="gesuchFile" accept=".pdf" required class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--color-text-primary);">Jahr</label>
                        <select id="uploadYear" required class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                            <option value="2030">2030</option>
                            <option value="2029">2029</option>
                            <option value="2028">2028</option>
                            <option value="2027">2027</option>
                            <option value="2026">2026</option>
                            <option value="2025" selected>2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--color-text-primary);">Beschreibung</label>
                        <textarea id="uploadDescription" rows="3" class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);" placeholder="Kurze Beschreibung des Gesuchs..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeUploadModal()" class="px-4 py-2 border rounded-lg" style="border-color: var(--color-border); color: var(--color-text-secondary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 text-white rounded-lg" style="background-color: var(--color-green);">
                            Hochladen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Upload System -->
    <script src="../scripts/upload-enhanced.js"></script>
    
    <script>
        // Archive System - Database Connected
        let availableYears = [];
        let archiveData = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('SBV Archiv System geladen');
            loadAvailableYears();
            
            // Initialize Enhanced Upload System
            setTimeout(() => {
                initializeEnhancedUpload();
            }, 1000);
        });

        // Load available years from database
        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/gesuche');
                const data = await response.json();
                
                if (data.success) {
                    // Extract unique years
                    const years = [...new Set(data.data.map(g => g.jahr))].sort((a, b) => b - a);
                    availableYears = years;
                    
                    // Update year selector
                    updateYearSelector(years);
                    
                    // Load archive folders
                    loadArchiveFolders(years);
                    
                    // Load statistics for each year
                    loadYearStatistics(years);
                }
            } catch (error) {
                console.error('Fehler beim Laden der Jahre:', error);
            }
        }

        // Update year selector dropdown
        function updateYearSelector(years) {
            const selector = document.getElementById('working-year');
            selector.innerHTML = '';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === new Date().getFullYear()) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        // Load archive folders with real data
        function loadArchiveFolders(years) {
            const container = document.querySelector('.grid');
            container.innerHTML = '';
            
            years.forEach(year => {
                const folderDiv = createArchiveFolder(year);
                container.appendChild(folderDiv);
            });
        }

        // Create archive folder element
        function createArchiveFolder(year) {
            const div = document.createElement('div');
            div.className = 'group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300';
            div.onclick = () => openArchive(year);
            
            div.innerHTML = `
                <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                    <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                </div>
                <p class="text-base font-semibold" style="color: var(--color-text-primary);">${year}</p>
                <p class="text-xs" style="color: var(--color-text-secondary);" id="stats-${year}">Lade...</p>
            `;
            
            return div;
        }

        // Load statistics for years
        async function loadYearStatistics(years) {
            for (const year of years) {
                try {
                    const [gesucheRes, berichteRes] = await Promise.all([
                        fetch(`/api/gesuche?jahr=${year}`),
                        fetch(`/api/berichte?jahr=${year}`)
                    ]);
                    
                    const gesucheData = await gesucheRes.json();
                    const berichteData = await berichteRes.json();
                    
                    const gesucheCount = gesucheData.success ? gesucheData.count : 0;
                    const berichteCount = berichteData.success ? berichteData.count : 0;
                    
                    const statsElement = document.getElementById(`stats-${year}`);
                    if (statsElement) {
                        statsElement.textContent = `${gesucheCount} Gesuche, ${berichteCount} Berichte`;
                    }
                    
                    // Store data for detailed view
                    archiveData[year] = {
                        gesuche: gesucheData.data || [],
                        berichte: berichteData.data || []
                    };
                } catch (error) {
                    console.error(`Fehler beim Laden der Statistiken f√ºr ${year}:`, error);
                    const statsElement = document.getElementById(`stats-${year}`);
                    if (statsElement) {
                        statsElement.textContent = 'Fehler beim Laden';
                    }
                }
            }
        }

        // Open Archive Function with real data
        function openArchive(year) {
            console.log(`√ñffne Archiv f√ºr Jahr: ${year}`);
            
            const data = archiveData[year];
            if (!data) {
                alert(`Daten f√ºr ${year} noch nicht geladen. Bitte warten Sie einen Moment.`);
                return;
            }
            
            // Kategorisiere Gesuche nach Typ
            const partnerGesuche = data.gesuche.filter(g => g.gesuch_typ === 'partner' || !g.gesuch_typ);
            const finanzGesuche = data.gesuche.filter(g => g.gesuch_typ === 'finanzgesuch');
            const berichte = data.berichte;
            
            let content = `=== ARCHIV ${year} ===\\n\\n`;
            content += `üìã PARTNER-GESUCHE (${partnerGesuche.length}):\\n`;
            partnerGesuche.forEach((g, i) => {
                content += `${i+1}. ${g.titel} (${g.status})\\n`;
            });
            
            content += `\\nüí∞ FINANZGESUCHE (${finanzGesuche.length}):\\n`;
            finanzGesuche.forEach((g, i) => {
                content += `${i+1}. ${g.titel} (${g.status})`;
                if (g.finanz_betrag) content += ` - CHF ${g.finanz_betrag}`;
                content += `\\n`;
            });
            
            content += `\\nüìä BERICHTE (${berichte.length}):\\n`;
            berichte.forEach((b, i) => {
                content += `${i+1}. ${b.titel} (${b.status})\\n`;
            });
            
            alert(content);
            
            // In Zukunft: √ñffne detaillierte Archiv-Ansicht
            // showArchiveDetail(year, data);
        }

        // Upload Gesuch Functions
        function uploadGesuch() {
            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadModal').classList.add('flex');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            document.getElementById('uploadForm').reset();
            
            // Clear extraction preview
            const preview = document.querySelector('.extraction-preview');
            if (preview) {
                preview.remove();
            }
        }

        // ===== ENHANCED UPLOAD SYSTEM =====
        
        function initializeEnhancedUpload() {
            console.log('üöÄ Enhanced Upload System wird initialisiert...');
            
            // File Input Change Handler f√ºr intelligente Jahr-Erkennung
            const gesuchFileInput = document.getElementById('gesuchFile');
            if (gesuchFileInput) {
                gesuchFileInput.addEventListener('change', handleIntelligentFileSelection);
                console.log('‚úÖ File Change Handler registriert');
            }
        }

        function handleIntelligentFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('üìé Datei ausgew√§hlt:', file.name, 'Gr√∂√üe:', file.size);

            // Extrahiere Jahr aus Dateiname
            const yearMatches = file.name.match(/20(\d{2})/g);
            if (yearMatches && yearMatches.length > 0) {
                const detectedYear = parseInt(yearMatches[0]);
                console.log('üìÖ Jahr erkannt:', detectedYear);
                
                // Setze erkanntes Jahr im Dropdown
                const yearSelect = document.getElementById('uploadYear');
                if (yearSelect) {
                    const yearOption = yearSelect.querySelector(`option[value="${detectedYear}"]`);
                    if (yearOption) {
                        yearSelect.value = detectedYear;
                        console.log('‚úÖ Jahr automatisch gesetzt:', detectedYear);
                        
                        // Visuelles Feedback
                        yearSelect.style.background = '#dcfce7'; // Gr√ºner Hintergrund
                        setTimeout(() => {
                            yearSelect.style.background = '';
                        }, 2000);
                    }
                }
            }

            // Generiere automatische Beschreibung
            const beschreibungField = document.getElementById('uploadDescription');
            if (beschreibungField) {
                const autoDescription = `Hochgeladen am ${new Date().toLocaleDateString('de-DE')} - ${file.name.replace('.pdf', '').replace(/[-_]/g, ' ')}`;
                beschreibungField.value = autoDescription;
                console.log('üìù Beschreibung automatisch gesetzt');
            }

            // Zeige Extraktion-Info
            showExtractionPreview(file);
        }

        function showExtractionPreview(file) {
            // Entferne vorherige Preview
            const existingPreview = document.querySelector('.extraction-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // Erstelle neue Preview
            const preview = document.createElement('div');
            preview.className = 'extraction-preview bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3';
            
            const yearMatches = file.name.match(/20(\d{2})/g);
            const detectedYear = yearMatches ? parseInt(yearMatches[0]) : new Date().getFullYear();
            
            preview.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-blue-600">ü§ñ</span>
                    <span class="font-semibold text-blue-800 text-sm">Automatisch erkannt:</span>
                </div>
                <div class="text-sm text-blue-700 space-y-1">
                    <div><strong>Jahr:</strong> ${detectedYear}</div>
                    <div><strong>Datei:</strong> ${file.name}</div>
                    <div><strong>Gr√∂√üe:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                </div>
                <p class="text-xs text-blue-600 mt-2">üìù Felder wurden automatisch ausgef√ºllt - bitte √ºberpr√ºfen!</p>
            `;

            // F√ºge Preview nach dem Datei-Input hinzu
            const fileInputDiv = document.getElementById('gesuchFile').parentNode;
            fileInputDiv.appendChild(preview);
        }

        // Jahr-Fix Tool Integration (f√ºr Button-Aufruf)
        async function fixYearMismatches() {
            if (!confirm('M√∂chten Sie alle Jahr-Mismatches in der Datenbank korrigieren?\n\nDies wird automatisch die Jahre basierend auf Dateinamen aktualisieren.')) {
                return;
            }

            try {
                const token = sessionStorage.getItem('sbv_token');
                const response = await fetch('/api/debug/fix-years', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ Erfolg!\n\n${result.fixedCount} Jahr-Mismatches wurden behoben.\nInsgesamt √ºberpr√ºft: ${result.totalMismatches} Eintr√§ge`);
                    loadAvailableYears(); // Refresh display
                } else {
                    alert('‚ùå Fehler: ' + result.message);
                }
            } catch (error) {
                console.error('Fehler beim Jahr-Fix:', error);
                alert('‚ùå Fehler beim Korrigieren der Jahre: ' + error.message);
            }
        }

        // Handle upload form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Upload form submitted');
            
            const formData = new FormData();
            const file = document.getElementById('gesuchFile').files[0];
            const year = document.getElementById('uploadYear').value;
            const description = document.getElementById('uploadDescription').value;
            
            console.log('File:', file, 'Year:', year, 'Description:', description);
            
            if (!file) {
                alert('Bitte w√§hlen Sie eine PDF-Datei aus.');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('Bitte w√§hlen Sie nur PDF-Dateien aus.');
                return;
            }
            
            formData.append('gesuch', file);
            formData.append('jahr', year);
            formData.append('beschreibung', description);
            
            try {
                const token = sessionStorage.getItem('sbv_token');
                console.log('Token found:', token ? 'Yes' : 'No');
                
                if (!token) {
                    alert('Sie sind nicht angemeldet. Bitte melden Sie sich erneut an.');
                    window.location.href = '/login.html';
                    return;
                }
                
                console.log('Sending upload request...');
                
                const response = await fetch('/api/gesuche/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    alert('Gesuch erfolgreich hochgeladen!');
                    closeUploadModal();
                    loadAvailableYears(); // Refresh the display
                } else {
                    alert('Fehler beim Hochladen: ' + result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Fehler beim Hochladen der Datei: ' + error.message);
            }
        });

        // Create new year
        async function createNewYear() {
            const selectedYear = document.getElementById('working-year').value;
            const currentYear = new Date().getFullYear();
            
            if (confirm(`M√∂chten Sie ein neues Archiv f√ºr das Gesuchsjahr ${selectedYear} erstellen?`)) {
                try {
                    // Hier k√∂nnte man ein neues Jahr in der Datenbank initialisieren
                    console.log(`Neues Gesuchsjahr ${selectedYear} erstellt`);
                    alert(`Gesuchsjahr ${selectedYear} wurde erfolgreich erstellt!`);
                    
                    // Reload data
                    loadAvailableYears();
                } catch (error) {
                    console.error('Fehler beim Erstellen des neuen Jahres:', error);
                    alert('Fehler beim Erstellen des neuen Jahres');
                }
            }
        }

        // File upload for AI analysis
        async function uploadArchiveFile(file, year) {
            const formData = new FormData();
            formData.append('document', file);
            formData.append('jahr', year);
            formData.append('typ', 'archiv');
            
            try {
                const response = await fetch('/api/archiv/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Dokument erfolgreich analysiert:', result.data.extractedData);
                    alert(`Dokument analysiert!\\n\\nExtrahierte Teilprojekte: ${result.data.extractedData.teilprojekte?.length || 0}\\nKI-Vertrauen: ${(result.data.extractedData.ai_confidence * 100).toFixed(1)}%`);
                    
                    // Reload archive data
                    loadAvailableYears();
                } else {
                    throw new Error(result.error || 'Upload fehlgeschlagen');
                }
            } catch (error) {
                console.error('Upload-Fehler:', error);
                alert('Fehler beim Upload: ' + error.message);
            }
        }

        // Add event listener to create button
        document.addEventListener('DOMContentLoaded', function() {
            const createButton = document.querySelector('button[style*="background-color: var(--color-green)"]');
            if (createButton) {
                createButton.onclick = createNewYear;
            }
        });
    </script>
</body>
</html>
