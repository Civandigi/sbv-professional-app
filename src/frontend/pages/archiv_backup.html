<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SBV Archiv - Jahresübersicht</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Plus+Jakarta+Sans:wght@400;500;700;800&amp;display=swap" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        /* Cache-Bust: 2025-01-22-15:30 */
        :root {
            --color-primary: #A4D2F4;
            --color-secondary: #6BAF38;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-success: #10b981;
            --color-text-primary: #111827;
            --color-text-secondary: #6B7280;
            --color-bg-primary: #ffffff;
            --color-bg-secondary: #f3f4f6;
            --color-card-background: #FFFFFF;
            --color-border: #E5E7EB;
            --color-red: #DC2626;
            --color-black: #000000;
            --color-light-blue: #A4D2F4;
            --color-blue: #3B82F6;
            --color-green: #6BAF38;
            --color-background: #F8FAFC;
            --color-orange: #F59E0B;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--color-background);
        }
    </style>
</head>
<body class="bg-[var(--color-background)]">
    <div class="w-full">
        <!-- Header Section -->
        <div class="pl-8 pr-8 pt-8 pb-0 mb-8">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 style="font-size: 1.875rem; font-weight: 700; color: #111827; margin-bottom: 1rem;">Archiv</h1>
                    <p class="text-lg" style="color: var(--color-text-secondary);">Wählen Sie das Jahr aus, für das Sie Gesuche und Berichte verwalten möchten oder erstellen Sie ein neues Archiv.</p>
                </div>
                <!-- Upload Buttons - Prominente Position -->
                <div class="flex gap-3">
                    <button class="flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-white text-sm font-semibold hover:opacity-90 transition-colors" style="background-color: var(--color-green);" onclick="uploadGesuch()">
                        <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        <span>Gesuch hochladen</span>
                    </button>
                    <button class="flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-white text-sm font-semibold hover:opacity-90 transition-colors" style="background-color: var(--color-blue);" onclick="uploadAnhang()">
                        <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16.5,6.5C15.67,6.5 15,7.17 15,8C15,8.83 15.67,9.5 16.5,9.5C17.33,9.5 18,8.83 18,8C18,7.17 17.33,6.5 16.5,6.5M6,2A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6M13,9V4.5L18.5,10H14A1,1 0 0,1 13,9Z"/>
                        </svg>
                        <span>Anhang</span>
                    </button>
                    <button class="flex items-center justify-center gap-2 rounded-lg px-4 py-2 text-white text-sm font-semibold hover:opacity-90 transition-colors" style="background-color: var(--color-secondary);" onclick="uploadDokument()">
                        <svg fill="currentColor" height="16" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9,2A2,2 0 0,0 7,4V20A2,2 0 0,0 9,22H15A2,2 0 0,0 17,20V8L11,2H9M11,9V4.5L16.5,10H12A1,1 0 0,1 11,9Z"/>
                        </svg>
                        <span>Dokument</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Working Year Selection -->
        <div class="ml-8 mr-8 mb-12">
            <div class="flex items-center gap-4">
                <div class="flex-1 max-w-xs">
                    <label class="block text-sm font-semibold mb-3" style="color: var(--color-text-primary);">Gesuchsjahr</label>
                    <select class="w-full rounded-lg border py-3 px-4 bg-white" style="border-color: var(--color-border); color: var(--color-text-primary);" id="working-year">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Annual Archives Section -->
        <div class="ml-8 mr-8">
            <h2 class="text-2xl font-bold mb-8" style="color: var(--color-text-primary);">Jahresarchive</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-8">
                
                <!-- 2023 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2023')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2023</p>
                </div>

                <!-- 2022 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2022')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2022</p>
                </div>

                <!-- 2021 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2021')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2021</p>
                </div>

                <!-- 2020 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2020')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2020</p>
                </div>

                <!-- 2019 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2019')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2019</p>
                </div>

                <!-- 2018 Folder -->
                <div class="group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300" onclick="openArchive('2018')">
                    <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                        <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                        </svg>
                    </div>
                    <p class="text-base font-semibold" style="color: var(--color-text-primary);">2018</p>
                </div>

            </div>
        </div>
        
        <!-- Upload Modal -->
        <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6" style="color: var(--color-text-primary);">
                    📋 Intelligentes Gesuch-Upload System
                </h3>
                
                <!-- Upload Form -->
                <form id="uploadForm" enctype="multipart/form-data" class="space-y-6">
                    <!-- Basis-Informationen -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-4">📄 Gesuch-Grunddaten</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Gesuch-Titel *</label>
                                <input type="text" id="gesuchTitel" required 
                                       placeholder="z.B. Landwirtschaftliche Kommunikation 2024"
                                       class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Jahr *</label>
                                <select id="uploadYear" required class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Gesamtbudget (CHF) *</label>
                                <input type="number" id="gesamtbudget" required 
                                       placeholder="4410000" step="1000"
                                       class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Gesuch-Typ</label>
                                <select id="gesuchTyp" class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                                    <option value="kommunikation">Kommunikation & Marketing</option>
                                    <option value="partner">Partner-Projekt</option>
                                    <option value="schulung">Schulung & Bildung</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Multi-File Upload -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-4">📎 Dateien hochladen</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Haupt-Gesuch (PDF) *</label>
                                <input type="file" id="gesuchFile" accept=".pdf" required 
                                       class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                                <p class="text-xs text-gray-500 mt-1">PDF-Datei mit der kompletten Gesuch-Struktur</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Zusätzliche Anhänge</label>
                                <input type="file" id="anhaengeFiles" multiple 
                                       accept=".pdf,.xlsx,.xls,.doc,.docx,.jpg,.jpeg,.png"
                                       class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);">
                                <p class="text-xs text-gray-500 mt-1">Excel-Tabellen, Bilder, zusätzliche Dokumente</p>
                            </div>
                        </div>
                    </div>

                    <!-- Erwartete Teilprojekte -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-4">🎯 Erwartete Teilprojekte (automatisch erkannt)</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="teilprojektePreview">
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-blue-500 rounded mr-3"></span>
                                <span>TP1 - Leitmedien</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 1'590'000</span>
                            </div>
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-green-500 rounded mr-3"></span>
                                <span>TP2 - Digitale Medien</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 490'000</span>
                            </div>
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-purple-500 rounded mr-3"></span>
                                <span>TP3 - Messen & Ausstellungen</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 630'000</span>
                            </div>
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-orange-500 rounded mr-3"></span>
                                <span>TP4 - Events & Aktionen</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 470'000</span>
                            </div>
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-red-500 rounded mr-3"></span>
                                <span>TP5 - Schulprojekte</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 140'000</span>
                            </div>
                            <div class="flex items-center p-2 bg-white rounded border">
                                <span class="w-4 h-4 bg-indigo-500 rounded mr-3"></span>
                                <span>TP6 - Partnerprojekte</span>
                                <span class="ml-auto text-sm text-gray-600">CHF 1'090'000</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-3">
                            ℹ️ Das System erkennt automatisch die Teilprojekte und erstellt entsprechende Rapport-Templates
                        </p>
                    </div>

                    <!-- Processing Options -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-4">⚙️ Verarbeitungsoptionen</h4>
                        <div class="space-y-3">
                            <label class="flex items-center">
                                <input type="checkbox" id="autoCreateRapporte" checked class="mr-3">
                                <span>Automatisch Rapport-Templates für alle Teilprojekte erstellen</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="extractKPIs" checked class="mr-3">
                                <span>KPI-Zielwerte aus Gesuch extrahieren</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="createMassnahmen" checked class="mr-3">
                                <span>Maßnahmen-Strukturen automatisch anlegen</span>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-end gap-4 pt-4 border-t">
                        <button type="button" onclick="closeUploadModal()" 
                                class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                            Abbrechen
                        </button>
                        <button type="submit" 
                                class="px-8 py-2 text-white rounded-lg hover:opacity-90 font-semibold" 
                                style="background-color: var(--color-green);">
                            🚀 Gesuch hochladen & verarbeiten
                        </button>
                    </div>
                </form>
            </div>
        </div>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-semibold mb-2" style="color: var(--color-text-primary);">Beschreibung</label>
                        <textarea id="uploadDescription" rows="3" class="w-full border rounded-lg px-3 py-2" style="border-color: var(--color-border);" placeholder="Kurze Beschreibung des Gesuchs..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeUploadModal()" class="px-4 py-2 border rounded-lg" style="border-color: var(--color-border); color: var(--color-text-secondary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="px-4 py-2 text-white rounded-lg" style="background-color: var(--color-green);">
                            Hochladen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Archive System - Database Connected
        let availableYears = [];
        let archiveData = {};

        document.addEventListener('DOMContentLoaded', function() {
            console.log('SBV Archiv System geladen');
            loadAvailableYears();
        });

        // Load available years from database
        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/gesuche');
                const data = await response.json();
                
                if (data.success) {
                    // Extract unique years
                    const years = [...new Set(data.data.map(g => g.jahr))].sort((a, b) => b - a);
                    availableYears = years;
                    
                    // Update year selector
                    updateYearSelector(years);
                    
                    // Load archive folders
                    loadArchiveFolders(years);
                    
                    // Load statistics for each year
                    loadYearStatistics(years);
                }
            } catch (error) {
                console.error('Fehler beim Laden der Jahre:', error);
            }
        }

        // Update year selector dropdown
        function updateYearSelector(years) {
            const selector = document.getElementById('working-year');
            selector.innerHTML = '';
            
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === new Date().getFullYear()) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
        }

        // Load archive folders with real data
        function loadArchiveFolders(years) {
            const container = document.querySelector('.grid');
            container.innerHTML = '';
            
            years.forEach(year => {
                const folderDiv = createArchiveFolder(year);
                container.appendChild(folderDiv);
            });
        }

        // Create archive folder element
        function createArchiveFolder(year) {
            const div = document.createElement('div');
            div.className = 'group flex flex-col items-center text-center gap-4 cursor-pointer transform hover:-translate-y-1 transition-all duration-300';
            div.onclick = () => openArchive(year);
            
            div.innerHTML = `
                <div class="w-24 h-24 rounded-2xl flex items-center justify-center shadow-md group-hover:shadow-lg transition-shadow" style="background-color: var(--color-light-blue);">
                    <svg fill="white" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                </div>
                <p class="text-base font-semibold" style="color: var(--color-text-primary);">${year}</p>
                <p class="text-xs" style="color: var(--color-text-secondary);" id="stats-${year}">Lade...</p>
            `;
            
            return div;
        }

        // Load statistics for years
        async function loadYearStatistics(years) {
            for (const year of years) {
                try {
                    const [gesucheRes, berichteRes] = await Promise.all([
                        fetch(`/api/gesuche?jahr=${year}`),
                        fetch(`/api/berichte?jahr=${year}`)
                    ]);
                    
                    const gesucheData = await gesucheRes.json();
                    const berichteData = await berichteRes.json();
                    
                    const gesucheCount = gesucheData.success ? gesucheData.count : 0;
                    const berichteCount = berichteData.success ? berichteData.count : 0;
                    
                    const statsElement = document.getElementById(`stats-${year}`);
                    if (statsElement) {
                        statsElement.textContent = `${gesucheCount} Gesuche, ${berichteCount} Berichte`;
                    }
                    
                    // Store data for detailed view
                    archiveData[year] = {
                        gesuche: gesucheData.data || [],
                        berichte: berichteData.data || []
                    };
                } catch (error) {
                    console.error(`Fehler beim Laden der Statistiken für ${year}:`, error);
                    const statsElement = document.getElementById(`stats-${year}`);
                    if (statsElement) {
                        statsElement.textContent = 'Fehler beim Laden';
                    }
                }
            }
        }

        // Open Archive Function with real data
        function openArchive(year) {
            console.log(`Öffne Archiv für Jahr: ${year}`);
            
            const data = archiveData[year];
            if (!data) {
                alert(`Daten für ${year} noch nicht geladen. Bitte warten Sie einen Moment.`);
                return;
            }
            
            // Kategorisiere Gesuche nach Typ
            const partnerGesuche = data.gesuche.filter(g => g.gesuch_typ === 'partner' || !g.gesuch_typ);
            const finanzGesuche = data.gesuche.filter(g => g.gesuch_typ === 'finanzgesuch');
            const berichte = data.berichte;
            
            let content = `=== ARCHIV ${year} ===\\n\\n`;
            content += `📋 PARTNER-GESUCHE (${partnerGesuche.length}):\\n`;
            partnerGesuche.forEach((g, i) => {
                content += `${i+1}. ${g.titel} (${g.status})\\n`;
            });
            
            content += `\\n💰 FINANZGESUCHE (${finanzGesuche.length}):\\n`;
            finanzGesuche.forEach((g, i) => {
                content += `${i+1}. ${g.titel} (${g.status})`;
                if (g.finanz_betrag) content += ` - CHF ${g.finanz_betrag}`;
                content += `\\n`;
            });
            
            content += `\\n📊 BERICHTE (${berichte.length}):\\n`;
            berichte.forEach((b, i) => {
                content += `${i+1}. ${b.titel} (${b.status})\\n`;
            });
            
            alert(content);
            
            // In Zukunft: Öffne detaillierte Archiv-Ansicht
            // showArchiveDetail(year, data);
        }

        // Upload Gesuch Functions
        function uploadGesuch() {
            document.getElementById('uploadModal').classList.remove('hidden');
            document.getElementById('uploadModal').classList.add('flex');
            // Aktualisiere Jahr basierend auf Auswahl
            const workingYear = document.getElementById('working-year').value;
            document.getElementById('uploadYear').value = workingYear;
        }

        // Upload Anhang Funktion
        function uploadAnhang() {
            alert('Anhang hochladen: Diese Funktion ist noch nicht implementiert. Hier können Sie Anhänge wie PDF, Bilder, Excel etc. hochladen.');
            // Hier kann ein eigenes Modal für Anhänge geöffnet werden
        }

        // Upload Dokument Funktion
        function uploadDokument() {
            alert('Dokument hochladen: Diese Funktion ist noch nicht implementiert. Hier können Sie allgemeine Dokumente hochladen.');
            // Hier kann ein eigenes Modal für Dokumente geöffnet werden
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.add('hidden');
            document.getElementById('uploadModal').classList.remove('flex');
            document.getElementById('uploadForm').reset();
        }

        // Intelligente Gesuch-Verarbeitung
        async function handleUploadSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData();
            const gesuchFile = document.getElementById('gesuchFile').files[0];
            const anhaengeFiles = document.getElementById('anhaengeFiles').files;
            
            // Validierung
            if (!gesuchFile) {
                alert('Bitte wählen Sie eine Gesuch-PDF-Datei aus.');
                return;
            }
            
            // Progress anzeigen
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '🔄 Verarbeite Gesuch...';
            submitBtn.disabled = true;
            
            try {
                // Hauptdatei hinzufügen
                formData.append('gesuchFile', gesuchFile);
                formData.append('titel', document.getElementById('gesuchTitel').value);
                formData.append('jahr', document.getElementById('uploadYear').value);
                formData.append('gesamtbudget', document.getElementById('gesamtbudget').value);
                formData.append('gesuchTyp', document.getElementById('gesuchTyp').value);
                
                // Verarbeitungsoptionen
                formData.append('autoCreateRapporte', document.getElementById('autoCreateRapporte').checked);
                formData.append('extractKPIs', document.getElementById('extractKPIs').checked);
                formData.append('createMassnahmen', document.getElementById('createMassnahmen').checked);
                
                // Anhänge hinzufügen
                for (let i = 0; i < anhaengeFiles.length; i++) {
                    formData.append('anhaenge', anhaengeFiles[i]);
                }
                
                // Token für Authentifizierung
                const token = sessionStorage.getItem('sbv_token');
                
                // Upload mit intelligenter Verarbeitung
                const response = await fetch('/api/gesuche/upload-intelligent', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Erfolgsmeldung
                    showUploadSuccess(result.data);
                    closeUploadModal();
                    
                    // Archiv-Ansicht aktualisieren
                    setTimeout(() => {
                        openArchive(document.getElementById('uploadYear').value);
                    }, 2000);
                    
                } else {
                    throw new Error(result.error || 'Upload fehlgeschlagen');
                }
                
            } catch (error) {
                console.error('Upload Error:', error);
                alert('Fehler beim Upload: ' + error.message);
                
            } finally {
                // Button zurücksetzen
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        function showUploadSuccess(data) {
            const message = `
✅ GESUCH ERFOLGREICH HOCHGELADEN & VERARBEITET!

📋 Gesuch: ${data.gesuch.titel}
💰 Budget: CHF ${data.gesuch.gesamtbudget?.toLocaleString() || 'N/A'}
📊 Teilprojekte erstellt: ${data.teilprojekte?.length || 0}
📈 Rapporte generiert: ${data.rapporte?.length || 0}
📎 Anhänge: ${data.anhaenge?.length || 0}

Das System hat automatisch:
• Teilprojekte aus dem PDF extrahiert
• Rapport-Templates erstellt
• KPI-Zielwerte erkannt
• Maßnahmen-Strukturen angelegt

Sie werden zum Archiv weitergeleitet...
            `;
            alert(message);
        }

        // Event Listener für Upload Form
        document.addEventListener('DOMContentLoaded', function() {
            const uploadForm = document.getElementById('uploadForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', handleUploadSubmit);
            }
            
            // File preview für Teilprojekte aktualisieren
            const gesuchFile = document.getElementById('gesuchFile');
            if (gesuchFile) {
                gesuchFile.addEventListener('change', previewTeilprojekte);
            }
        });
        
        // Preview-Funktionen für bessere UX
        function previewTeilprojekte() {
            const file = document.getElementById('gesuchFile').files[0];
            const preview = document.getElementById('teilprojektePreview');
            
            if (file && file.type === 'application/pdf') {
                // Zeige "Analysiere..." Status
                preview.innerHTML = `
                    <div class="col-span-2 flex items-center justify-center p-4 bg-blue-100 rounded">
                        <div class="animate-spin w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full mr-3"></div>
                        <span>Analysiere PDF-Struktur...</span>
                    </div>
                `;
                
                // Nach kurzer Zeit Standard-Preview anzeigen
                setTimeout(() => {
                    preview.innerHTML = `
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-blue-500 rounded mr-3"></span>
                            <span>TP1 - Leitmedien</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 1'590'000</span>
                        </div>
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-green-500 rounded mr-3"></span>
                            <span>TP2 - Digitale Medien</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 490'000</span>
                        </div>
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-purple-500 rounded mr-3"></span>
                            <span>TP3 - Messen & Ausstellungen</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 630'000</span>
                        </div>
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-orange-500 rounded mr-3"></span>
                            <span>TP4 - Events & Aktionen</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 470'000</span>
                        </div>
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-red-500 rounded mr-3"></span>
                            <span>TP5 - Schulprojekte</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 140'000</span>
                        </div>
                        <div class="flex items-center p-2 bg-white rounded border">
                            <span class="w-4 h-4 bg-indigo-500 rounded mr-3"></span>
                            <span>TP6 - Partnerprojekte</span>
                            <span class="ml-auto text-sm text-gray-600">CHF 1'090'000</span>
                        </div>
                    `;
                }, 1500);
            }
        }

        // Handle upload form submission
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('Upload form submitted');
            
            const formData = new FormData();
            const file = document.getElementById('gesuchFile').files[0];
            const year = document.getElementById('uploadYear').value;
            const description = document.getElementById('uploadDescription').value;
            
            console.log('File:', file, 'Year:', year, 'Description:', description);
            
            if (!file) {
                alert('Bitte wählen Sie eine PDF-Datei aus.');
                return;
            }
            
            if (file.type !== 'application/pdf') {
                alert('Bitte wählen Sie nur PDF-Dateien aus.');
                return;
            }
            
            formData.append('gesuch', file);
            formData.append('jahr', year);
            formData.append('beschreibung', description);
            
            try {
                const token = sessionStorage.getItem('sbv_token');
                console.log('Token found:', token ? 'Yes' : 'No');
                
                if (!token) {
                    alert('Sie sind nicht angemeldet. Bitte melden Sie sich erneut an.');
                    window.location.href = '/login.html';
                    return;
                }
                
                console.log('Sending upload request...');
                
                const response = await fetch('/api/gesuche/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    alert('Gesuch erfolgreich hochgeladen!');
                    closeUploadModal();
                    loadAvailableYears(); // Refresh the display
                } else {
                    alert('Fehler beim Hochladen: ' + result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Fehler beim Hochladen der Datei: ' + error.message);
            }
        });

        // Create new year
        async function createNewYear() {
            const selectedYear = document.getElementById('working-year').value;
            const currentYear = new Date().getFullYear();
            
            if (confirm(`Möchten Sie ein neues Archiv für das Gesuchsjahr ${selectedYear} erstellen?`)) {
                try {
                    // Hier könnte man ein neues Jahr in der Datenbank initialisieren
                    console.log(`Neues Gesuchsjahr ${selectedYear} erstellt`);
                    alert(`Gesuchsjahr ${selectedYear} wurde erfolgreich erstellt!`);
                    
                    // Reload data
                    loadAvailableYears();
                } catch (error) {
                    console.error('Fehler beim Erstellen des neuen Jahres:', error);
                    alert('Fehler beim Erstellen des neuen Jahres');
                }
            }
        }

        // File upload for AI analysis
        async function uploadArchiveFile(file, year) {
            const formData = new FormData();
            formData.append('document', file);
            formData.append('jahr', year);
            formData.append('typ', 'archiv');
            
            try {
                const response = await fetch('/api/archiv/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Dokument erfolgreich analysiert:', result.data.extractedData);
                    alert(`Dokument analysiert!\\n\\nExtrahierte Teilprojekte: ${result.data.extractedData.teilprojekte?.length || 0}\\nKI-Vertrauen: ${(result.data.extractedData.ai_confidence * 100).toFixed(1)}%`);
                    
                    // Reload archive data
                    loadAvailableYears();
                } else {
                    throw new Error(result.error || 'Upload fehlgeschlagen');
                }
            } catch (error) {
                console.error('Upload-Fehler:', error);
                alert('Fehler beim Upload: ' + error.message);
            }
        }

        // Add event listener to create button
        document.addEventListener('DOMContentLoaded', function() {
            const createButton = document.querySelector('button[style*="background-color: var(--color-green)"]');
            if (createButton) {
                createButton.onclick = createNewYear;
            }
        });
    </script>
</body>
</html>
